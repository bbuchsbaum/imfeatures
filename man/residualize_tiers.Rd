% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/residualize_tiers.R
\name{residualize_tiers}
\alias{residualize_tiers}
\title{Hierarchical residualization of tiered feature matrices with PCA}
\usage{
residualize_tiers(
  feature_list,
  numpcs = NULL,
  pca_method = c("stats", "irlba")
)
}
\arguments{
\item{feature_list}{Named list of numeric matrices, each of dimension N_samples × P_i.}

\item{numpcs}{Integer scalar or numeric vector, or NULL. If NULL (default), uses up to 50 PCs per tier (or fewer, if a tier has <50 features).}

\item{pca_method}{Character string, one of "stats" (default, uses \code{stats::prcomp}) or "irlba" (uses \code{irlba::prcomp_irlba}).
"irlba" can be faster for matrices where N_samples < N_features, especially if only a small number of PCs are requested.
If "irlba" is chosen and the package is not installed, a warning is issued and it falls back to "stats".}
}
\value{
An object of class \code{residualized_tiers}, a list with components:
\describe{
  \item{pca}{Named list of PCA objects (from \code{stats::prcomp} or \code{irlba::prcomp_irlba}) for each tier.}
  \item{pc_scores}{Named list of PC score matrices (N_samples × numpcs[i]).}
  \item{residuals}{Named list of residualized PC matrices after regressing out previous tiers.}
  \item{projection_bases}{Named list. For each tier (except the first, which is NULL), stores the orthonormal basis matrix Q (from QR decomposition) of the cumulative *non-residualized* PC scores from all *preceding* tiers observed during training. This Q was used to project and then residualize the current tier\'s PC scores *during the training phase*. This component is primarily for diagnostic/inspection purposes and is *not* used by the \code{predict.residualized_tiers} method (which recomputes bases from new data).}
  \item{numpcs}{Integer vector of number of PCs per tier.}
  \item{tiers}{Character vector of tier names (names of \code{feature_list}).}
}
}
\description{
Given a named list of feature matrices (e.g., low-, mid-, high-tier features),
perform PCA within each tier to reduce to a specified number of components,
then sequentially residualize each tier's PCs against all previous tiers.
}
\details{
The process for each tier is as follows:
1. The raw feature matrix for the tier is centered, scaled, and PCA is performed using the specified \code{pca_method}.
2. The top \code{numpcs} for that tier are selected.
3. These selected PC scores are then residualized against the cumulative set of *non-residualized* PC scores from all preceding tiers.
   This ensures that \code{residuals[[tier_i]]} is orthogonal to \code{residuals[[tier_j]]} for i != j, 
   and also orthogonal to the non-residualized scores of preceding tiers.

To apply this full transformation (PCA and sequential residualization) to a new dataset, use the S3 method
\code{predict(object, newdata)}, where \code{object} is the result of \code{residualize_tiers} and \code{newdata}
is a named list of feature matrices matching the structure of the original \code{feature_list}.
}
